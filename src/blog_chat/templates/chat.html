<div class="container mx-auto p-4 max-w-2xl">
    <div class="card bg-base-200 shadow-xl mb-4">
        <div class="card-body p-4">
            <h2 class="card-title flex items-center gap-2">
                {% if post %} {{ post.title }}
                {% else %} Off-topic
                {% endif %}
                <span class="badge badge-primary">chat</span>
            </h2>
        </div>
    </div>

    <form id="username-section" class="mb-4" hx-post="/api/set-username" hx-swap="outerHTML">
        <div class="flex gap-2">
            <input name="username" class="input input-bordered join-item flex-1" type="text" placeholder="Enter your name" maxlength="50" />
            <button class="btn btn-primary join-item">Join</button>
        </div>
    </form>

    <div class="chat-box h-96 overflow-y-auto mb-4 space-y-2" id="chat-messages">
    </div>

    <div class="join w-full">
        <input id="chat-input" class="input input-bordered join-item flex-1" type="text" placeholder="Type a message..." />
        <button id="send-btn" class="btn btn-primary join-item">Send</button>
    </div>

    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/; SameSite=Lax`;
        }

        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');
        const usernameSection = document.getElementById('username-section');

        let token = getCookie('chat_token');
        const room = "{{ room|default('offtopic') }}";

        if (token) {
            usernameSection.style.display = 'none';
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/chat?room=${room}${token ? '&token=' + token : ''}`;
        const ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            console.log('WebSocket connected');
        };

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function createMessageElement(data) {
            const div = document.createElement('div');
            div.className = 'chat chat-end';
            div.dataset.messageId = data.id;
            
            const weatherHtml = data.weather 
                ? `<span class="text-xs ml-2">${data.weather}</span>`
                : (data.type === 'message' ? `<span class="text-xs ml-2 loading loading-dots loading-xs"></span>` : '');
            
            div.innerHTML = `
                <div class="chat-header flex items-center gap-2">
                    <span class="font-bold text-sm">${data.username}</span>
                    <span class="text-xs opacity-50">${formatTimestamp(data.timestamp)}</span>
                    ${weatherHtml}
                </div>
                <div class="chat-bubble chat-bubble-secondary">${data.content}</div>
            `;
            return div;
        }

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'history') {
                chatMessages.innerHTML = '';
                data.messages.forEach(msg => {
                    chatMessages.appendChild(createMessageElement(msg));
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else if (data.type === 'message') {
                chatMessages.appendChild(createMessageElement(data));
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else if (data.type === 'weather_update') {
                const msgElement = chatMessages.querySelector(`[data-message-id="${data.message_id}"]`);
                if (msgElement) {
                    const header = msgElement.querySelector('.chat-header');
                    const existingLoader = header.querySelector('.loading');
                    if (existingLoader) {
                        existingLoader.remove();
                    }
                    const weatherSpan = document.createElement('span');
                    weatherSpan.className = 'text-xs ml-2';
                    weatherSpan.textContent = data.weather;
                    header.appendChild(weatherSpan);
                }
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected');
        };

        function sendMessage() {
            const message = chatInput.value.trim();
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                chatInput.value = '';
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</div>

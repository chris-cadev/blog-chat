<div class="container mx-auto p-4 max-w-2xl">
    <div class="card bg-base-200 shadow-xl mb-4">
        <div class="card-body p-4">
            <h2 class="card-title flex items-center gap-2">
                {% if post %} {{ post.title }}
                {% else %} Off-topic
                {% endif %}
                <span class="badge badge-primary">chat</span>
            </h2>
        </div>
    </div>

    <div id="username-section">
        <form class="mb-4" hx-post="/api/set-username?room={{ room|default('offtopic') }}" hx-swap="outerHTML">
            <input type="hidden" name="room" value="{{ room|default('offtopic') }}" />
            <div class="flex gap-2">
                <input name="username" class="input input-bordered join-item flex-1" type="text"
                    placeholder="Enter your name" maxlength="50" />
                <button class="btn btn-primary join-item">Join</button>
            </div>
        </form>
    </div>

    <div class="chat-box h-96 overflow-y-auto mb-4 space-y-2" id="chat-messages">
    </div>

    <div class="join w-full">
        <input id="chat-input" class="input input-bordered join-item flex-1" type="text"
            placeholder="Type a message..." />
        <button id="send-btn" class="btn btn-primary join-item">Send</button>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', (e) => {
        const usernameSection = document.getElementById('username-section');
        if (!usernameSection || usernameSection.querySelector('form')) return;
        
        const token = document.cookie.match(/chat_token=([^;]+)/)?.[1];
        if (token) {
            window.location.reload();
        }
    });
</script>

<div class="container mx-auto p-4 max-w-2xl">
    <div class="card bg-base-200 shadow-xl mb-4">
        <div class="card-body p-4">
            <h2 class="card-title flex items-center gap-2">
                {% if post %} {{ post.title }}
                {% else %} Off-topic
                {% endif %}
                <span class="badge badge-primary">chat</span>
            </h2>
        </div>
    </div>

    <div id="username-section">
        {% if not username %}
        <form class="mb-4" hx-post="/api/set-username?room={{ room|default('offtopic') }}" hx-swap="outerHTML">
            <input type="hidden" name="room" value="{{ room|default('offtopic') }}" />
            <div class="flex gap-2">
                <input name="username" class="input input-bordered join-item flex-1" type="text"
                    placeholder="Enter your name" maxlength="50" />
                <button class="btn btn-primary join-item">Join</button>
            </div>
        </form>
        {% else %}
        <div class="mb-4 flex items-center justify-between">
            <span class="text-sm">Logged in as <span class="font-bold">{{ username }}</span></span>
            <button class="btn btn-sm btn-ghost" hx-post="/api/clear-username?room={{ room|default('offtopic') }}"
                hx-swap="outerHTML">Change username</button>
        </div>
        {% endif %}
    </div>

    <div id="chat-messages" class="chat h-96 overflow-y-auto mb-4 space-y-2" data-username="{{ username|default('') }}">
    </div>

    <div class="join w-full">
        <input id="chat-input" class="input input-bordered join-item flex-1" type="text"
            placeholder="Type a message..." />
        <button id="send-btn" class="btn btn-primary join-item">Send</button>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', (e) => {
        const usernameSection = document.getElementById('username-section');
        if (!usernameSection) return;

        const hasForm = usernameSection.querySelector('form');
        if (!hasForm) {
            window.location.reload();
        }
    });
</script>
